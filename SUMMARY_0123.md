# PXE Server Setup & Troubleshooting Summary (2026-01-23)

This document summarizes the steps taken, problems encountered, and solutions implemented to set up and troubleshoot the PXE server, supporting both IPv4 and IPv6 network booting, as well as a DHCP lease viewer web application.

## 1. Initial Diagnosis & Git Restoration
*   **Problem:** PXE/DHCP services status check revealed potential configuration issues and the need for a stable baseline.
*   **Action:** Restored `pxe-server-config` repository to commit `6ef4477` to establish a known working state.
*   **Outcome:** Established a clean baseline for further configuration.

## 2. IPv6 Network Configuration (Netplan)
*   **Problem:** Server failed to bind to IPv6 address `fd00:192:168:1::1`, leading to `dnsmasq` startup failures. Discrepancy found between `README.md` and installed Netplan configuration.
*   **Action:** Modified `/etc/netplan/99-pxe-static.yaml` to explicitly configure `enx00e04c369f39` with static IPv4 (`192.168.1.1/24`) and IPv6 (`fd00:192:168:1::1/64`) addresses, and set `renderer: networkd`.
    *   *Correction:* Initially, `renderer: networkd` caused issues; reverted to `NetworkManager` for this file but manually configured IPv6 using `nmcli` when `NetworkManager` was confirmed to be the renderer.
*   **Outcome:** Server's `enx00e04c369f39` interface successfully configured with both static IPv4 and IPv6 addresses.

## 3. `dnsmasq` IPv6 Configuration & PXE Boot Issues
*   **Problem:** Clients (especially IPv6 PXE) failed to boot, with `PXE-E21: Remote boot cancelled` messages. Initial `dnsmasq` config had `dhcp-range` for IPv6 set to `ra-only`.
*   **Action:**
    *   Changed `dhcp-range=fd00:192:168:1::,ra-only,12h` to `dhcp-range=fd00:192:168:1::,slaac,12h` in `/etc/dnsmasq.d/pxe.conf`. This enables `dnsmasq` to act as a stateless DHCPv6 server and provide PXE boot information.
    *   Added `pxe-service` lines (e.g., `pxe-service=X86-64_EFI, "IPv6 PXE Boot", ipxe.efi`) to `/etc/dnsmasq.d/pxe.conf` to explicitly guide UEFI IPv6 clients.
*   **Outcome:** IPv6 network address acquisition worked, but IPv6 PXE boot still struggled.

## 4. `pxe-service` Conflict & IPv4 PXE Regression
*   **Problem:** After adding `pxe-service` lines for IPv6, IPv4 PXE boot failed, getting stuck at `Start PXE over IPv4`.
*   **Action:** Commented out the newly added `pxe-service` lines in `/etc/dnsmasq.d/pxe.conf` due to a likely conflict with existing IPv4 `dhcp-boot` directives.
*   **Outcome:** IPv4 PXE boot functionality was restored.

## 5. DHCP Lease Viewer Web Application (`leases.html`)
*   **Problem:** The `http://192.168.45.20/leases.html` page showed outdated information or "Error" status for hosts.
*   **Action:**
    *   **`generate_lease_html.py`:** Fixed `ValueError` in IP sorting (mixed IPv4/IPv6) by implementing robust `ipaddress` module-based sorting.
    *   **`leases_template.html`:** Corrected the JavaScript `fetch` call to target `ping_api.py` on port 5000 (e.g., `http://<server>:5000/api/status/<ip>`). Added "Lease Start" column to the template.
    *   **Column Alignment:** Ensured the number and order of data columns generated by `generate_lease_html.py` matched the headers in `leases_template.html`.
    *   **`ping_api.py`:** Installed `flask-cors`. Modified `ping_api.py` to add CORS headers. Enhanced status check to use `ping` first, then fallback to `nc -vz` on ports 22, 80, 443 if `ping` fails.
*   **Outcome:** The DHCP lease viewer web page now correctly displays up-to-date lease information and host status.

## 6. GRUB Bootloader Configuration
*   **Problem:** After iPXE chainloaded `grubx64.efi`, the system dropped to a `grub>` prompt, indicating `grub.cfg` was not found or not working.
*   **Action:**
    *   Created `/var/www/html/ubuntu-installer/EFI/boot/grub.cfg` with a menu entry to load `vmlinuz` and `initrd`.
    *   Initially configured `grub.cfg` to use TFTP, but this failed.
    *   **Revised `grub.cfg`:** Modified `grub.cfg` to explicitly use HTTP for loading kernel and initrd, setting `prefix=(http,...)` and `root=(http,...)`.
*   **Outcome:** GRUB was able to load kernel and initrd files (downloads showed "ok"). However, the system still fell into GRUB, or a new `autoexec.ipxe` timeout occurred, suggesting a different chainloading issue or client caching.

## 7. Bypassing GRUB
*   **Problem:** Persistent issues with GRUB (`error: disk 'tftp,192.168.1.1' not found.` despite `grub.cfg` changes) and `autoexec.ipxe` timeouts indicated GRUB was a consistent point of failure.
*   **Action:** Modified `boot.ipxe` to completely bypass GRUB. Instead of `chain`ing `grubx64.efi`, `boot.ipxe` now directly uses `kernel` and `initrd` commands to load the Ubuntu installer via HTTP.
*   **Outcome:** (Pending user confirmation) The client should now directly proceed to boot the Ubuntu installer after `vmlinuz` and `initrd` are downloaded.

---
**Note:** This summary will be committed to the git repository.
